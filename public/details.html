<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AliyaStore Diploma</title>
    <link rel="stylesheet" href="./css/product.css" />
    <link rel="stylesheet" href="./css/basic.css" />
    <link rel="stylesheet" href="./css/details.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
      rel="stylesheet"
    />
  </head>
  <style>
    .subscribe-box {
      position: relative;
      max-width: 260px;
      width: 100%;
      margin-bottom: 20px;
    }

    .footer-input {
      width: 100%;
      height: 42px;
      padding: 0 50px 0 12px;
      border-radius: 8px;
      border: 1px solid #534139;
      font-size: 14px;
      font-weight: 500;
      box-sizing: border-box;
      color: #0d0d0d;
    }

    .footer-input::placeholder {
      color: #aaa;
      font-size: 13px;
    }

    .footer-input:focus {
      border-color: #534139;
      box-shadow: 0 0 6px #534139;
      outline: none;
    }

    .send-btn {
      position: absolute;
      top: -2px;
      right: 1px;
      width: 52px;
      height: 55px;
      border-radius: 10%;
      background-color: #534139;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: background-color 0.3s;
    }

    .send-btn:hover {
      background-color: #6b5146;
    }

    .send-btn img {
      width: 30x;
      height: 30px;
    }
  </style>
  <body>
    <header>
      <div class="container">
        <div class="header-bottom">
          <a href="Catalog_Main.html">
            <img src="/images/arrow_basket.svg" alt="Повернутись до каталогу" />
          </a>
          <h1>Деталі замовлення</h1>
          <div class="header-icons">
            <a href="favorites.html" class="icon-link"
              ><img src="./images/white/heart.svg" alt="Додати в обране"
            /></a>
            <a href="basket.html" class="icon-link"
              ><img src="./images/white/basket.svg" alt="Додати в кошик"
            /></a>
            <a href="personalinfo.html" class="icon-link"
              ><img src="./images/white/user.svg" alt="Особистий кабінет"
            /></a>
          </div>
        </div>
      </div>
    </header>
    <section>
      <div class="container">
        <div class="checkout-wrapper">
          <form id="order-form" class="checkout-form">
            <!-- Особисті дані -->
            <div class="aside">
              <div class="row">
                <div class="form-group">
                  <label for="name">Ім’я</label>
                  <input type="text" id="name" required />
                </div>
                <div class="form-group">
                  <label for="surname">Прізвище</label>
                  <input type="text" id="surname" required />
                </div>
              </div>

              <div class="row">
                <div class="form-group">
                  <label for="phone">Телефон</label>
                  <input type="text" id="phone" required />
                </div>
                <div class="form-group">
                  <label for="email">E-mail</label>
                  <input type="email" id="email" required />
                </div>
              </div>

              <div class="row">
                <div class="form-group small">
                  <label for="city">Місто</label>
                  <input type="text" id="city" required />
                </div>
                <div class="form-group small">
                  <label for="address">Адреса</label>
                  <input type="text" id="address" required />
                </div>
                <div class="form-group small">
                  <label for="index">Поштовий індекс</label>
                  <input type="text" id="index" required />
                </div>
              </div>

              <!-- Суми -->
            </div>

            <!-- Оплата -->
            <div class="payment-methods">
              <h3>Метод оплати</h3>

              <label class="payment-option">
                <input type="radio" name="payment" value="card" checked />
                <span class="custom-radio"></span>
                <span>Карткою</span>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="cash" />
                <span class="custom-radio"></span>
                <span>Готівкою при отриманні</span>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="paypal" />
                <span class="custom-radio"></span>
                <span>PayPal</span>
              </label>
            </div>

            <!-- Поля картки -->
            <div id="card-form" class="card-form">
              <div class="row">
                <div class="form-group">
                  <label for="cardholder-name">Ім’я на картці</label>
                  <input type="text" id="cardholder-name" />
                </div>
                <div class="form-group">
                  <label for="card-number">Номер картки</label>
                  <input
                    type="text"
                    id="card-number"
                    placeholder="1234 5678 9012 3456"
                  />
                </div>
              </div>
              <div class="row">
                <div class="form-group">
                  <label for="expiry-date">Термін дії</label>
                  <input type="month" id="expiry-date" />
                </div>
                <div class="form-group">
                  <label for="ccv">CCV</label>
                  <input type="text" id="ccv" maxlength="4" />
                </div>
              </div>
            </div>

            <!-- Кнопка -->
            <button type="submit" class="checkout-btn">
              Оформити замовлення
            </button>
          </form>
          <aside
            class="order-summary"
            style="flex: 0 0 400px; border: 1px solid #ddd; padding: 1.5rem"
          >
            <h2 class="zam">Ваше замовлення</h2>
            <p>Сума: <span id="sum">0.00</span> грн</p>
            <p>Доставка: <span id="ship">0.00</span> грн</p>
            <div class="check-out">
              <p class="result">Всього: <span id="total">0.00</span> грн</p>
            </div>
          </aside>
        </div>
      </div>
    </section>
    <footer class="footer">
      <div class="container">
        <div class="footer-top">
          <div class="footer-logo-container">
            <a href="./index.html">
              <img
                src="./images/logo-footer.svg"
                alt="Логотип меблевого магазину"
                class="footer-logo"
            /></a>
            <p>
              <img
                src="./images/fi-bs-phone-call--footer.svg"
                alt=""
                class="footer-contacts"
              />
              +38 (067) 478 12 54
            </p>
            <p>
              <img
                src="./images/fi-bs-marker--footer.svg"
                alt=""
                class="footer-contacts"
              />
              проспект В'ячеслава Чорновола, 101, Львів, Україна
            </p>
          </div>
          <div class="footer-links">
            <ul>
              <li><a href="./about-us.html">Про нас</a></li>
              <li><a href="./catalog.html">Каталог</a></li>
              <li><a href="./contact-us.html">Контакти</a></li>
            </ul>
            <ul>
              <li><a href="./personalinfo.html">Особистий кабінет</a></li>
              <li><a href="./blog.html">Блог</a></li>
              <li><a href="./faqs.html">FAQ</a></li>
            </ul>
          </div>
          <div class="footer-subscribe">
            <p>Підписатися на електронну пошту</p>
            <div class="subscribe-box">
              <input
                class="input"
                type="email"
                placeholder="       your email..."
              />
              <button class="send-btn" id="subscribe-btn">
                <img src="./images/send.svg" alt="send" />
              </button>
            </div>
            <div class="modal-overlay" id="modal">
              <div class="modal-message fancy">
                <button class="modal-close" id="modal-close">×</button>
                <div class="modal-icon">
                  <img src="./images/checkmark.svg" />
                </div>
                <h2 class="modal-title">Дякуємо за підписку!</h2>
              </div>
            </div>

            <div class="social-icons">
              <div class="icon-container">
                <img class="dsh" src="./images/icon-instagram.svg" alt="" />
              </div>
              <div class="icon-container">
                <img src="./images/icon-facebook.svg" alt="" />
              </div>
              <div class="icon-container">
                <img src="./images/icon-twitter.svg" alt="" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("order-form");
        const summarySpans = document.querySelectorAll(".order-summary span");
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");

        // 1) Розрахунок сум
        let subtotal = 0;
        cart.forEach((i) => (subtotal += i.quantity * i.price));
        const shipping = 500;
        const total = subtotal + shipping;

        // Виводимо на сторінку
        if (summarySpans.length >= 3) {
          summarySpans[0].textContent = subtotal.toFixed(2);
          summarySpans[1].textContent = shipping.toFixed(2);
          summarySpans[2].textContent = total.toFixed(2);
        }

        // 2) Toggle карткової форми
        const cardForm = document.getElementById("card-form");
        document.querySelectorAll('input[name="payment"]').forEach((radio) => {
          radio.addEventListener("change", () => {
            cardForm.style.display = radio.value === "card" ? "block" : "none";
          });
        });
        // Виклик щоб показати/сховати при завантаженні
        document
          .querySelector('input[name="payment"]:checked')
          .dispatchEvent(new Event("change"));

        // 3) Сабміт форми
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Збираємо поля
          const data = {
            name: form.querySelector("#name").value.trim(),
            surname: form.querySelector("#surname").value.trim(),
            phone: form.querySelector("#phone").value.trim(),
            email: form.querySelector("#email").value.trim(),
            city: form.querySelector("#city").value.trim(),
            address: form.querySelector("#address").value.trim(),
            index: form.querySelector("#index").value.trim(),
            payment: form.querySelector('input[name="payment"]:checked').value,
            totalSum: subtotal,
            shipping: shipping,
            grandTotal: total,
            cartItems: cart,
          };

          // Додаткові поля картки якщо потрібно
          if (data.payment === "card") {
            data.cardholder = form
              .querySelector("#cardholder-name")
              .value.trim();
            data.cardNumber = form.querySelector("#card-number").value.trim();
            data.expiryDate = form.querySelector("#expiry-date").value.trim();
            data.ccv = form.querySelector("#ccv").value.trim();
          }

          console.log("▶ payload", data);

          try {
            const res = await fetch("/api/order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            console.log("← status", res.status);

            const txt = await res.text();
            console.log("← raw response", txt);

            let json;
            try {
              json = JSON.parse(txt);
            } catch {
              return alert("Отримано неприпустиму відповідь від сервера.");
            }

            if (!res.ok) {
              return alert(json.error || "Сталась помилка на сервері.");
            }

            alert(json.message || "Замовлення успішно оформлено!");
            form.reset();
            setTimeout(() => (location.href = "/order.html"), 1500);
          } catch (err) {
            console.error("❌ fetch error", err);
            alert("Не вдалося зв’язатися із сервером.");
          }
        });
      });
    </script>
  </body>
</html>
